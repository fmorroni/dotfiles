#!/bin/bash

if [[ -z $1 ]]; then
  echo "Missing argument. Usage: java-run <MainClass> [args...]"
  exit 1
fi

SAVE_FILE=".java_saves.txt"
OUTPUT_DIR=".classes"

mapfile -t JAVA_FILES < <(find . -type f -name "*.java")

declare -A LAST_MODIFIED
for file in "${JAVA_FILES[@]}"; do
  LAST_MODIFIED["$file"]=$(stat -c "%Y" "$file")
done

updateSaveFile() {
  for file in "${!LAST_MODIFIED[@]}"; do
    printf '%s,%s\n' "$file" "${LAST_MODIFIED[$file]}"
  done > "$SAVE_FILE"
}

# Check if we need to recompile everything
recompile_all=0
if [[ ! -f "$SAVE_FILE" ]]; then
  echo "First run detected. Compiling all Java files..."
  recompile_all=1
else
  declare -A SAVED_FILES
  while IFS=, read -r file last_modified; do
    SAVED_FILES["$file"]=$last_modified
  done < "$SAVE_FILE"

  # Check for new, deleted, or modified files
  for file in "${JAVA_FILES[@]}"; do
    if [[ -z ${SAVED_FILES["$file"]} ]]; then
      recompile_all=1; break
    elif [[ ${LAST_MODIFIED["$file"]} -gt ${SAVED_FILES["$file"]} ]]; then
      recompile_all=1; break
    fi
  done

  # Check for deleted files
  if [[ $recompile_all -eq 0 ]]; then
    for file in "${!SAVED_FILES[@]}"; do
      [[ -f "$file" ]] || { recompile_all=1; break; }
    done
  fi
fi

# Recompile if needed
if [[ $recompile_all -eq 1 ]]; then
  echo "Changes detected. Recompiling all Java files..."
  mkdir -p "$OUTPUT_DIR"
  javac -cp "$OUTPUT_DIR" -d "$OUTPUT_DIR" "${JAVA_FILES[@]}" || exit 1
  updateSaveFile
fi

echo -e "Running $1:"
echo "----------------------------------------"
exec java -cp "$OUTPUT_DIR" "$@"
